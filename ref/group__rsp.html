<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libdragon: RSP interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libdragon
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle"><div class="title">RSP interface<div class="ingroups"><a class="el" href="group__libdragon.html">libdragon</a> &raquo; <a class="el" href="group__lowlevel.html">Low Level Hardware Interfaces</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>RSP basic library.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:rsp_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rsp_8c.html">rsp.c</a></td></tr>
<tr class="memdesc:rsp_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Low-level RSP hardware library. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:rsp_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rsp_8h.html">rsp.h</a></td></tr>
<tr class="memdesc:rsp_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Low-level RSP hardware library. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p >RSP basic library. </p>
<p >This library offers very low-level support for RSP programming. The goal is to provide access to the hardware by exposing macros for all hardware registers, provide a few simple helpers to load and run RSP ucode (without any constraint or limitation on how the ucode should be designed, how it should communicate with the CPU, etc.), and a few debugging helpers to aid during development.</p>
<p >This documentation is not a guide to become a RSP programmer. It assumes familiarity with RSP programming concepts and focus on explaining libdragon RSP support.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Ucode definition and loading</h2>
<p >To define a RSP ucode, assuming you are using the n64.mk build system, it is sufficient to do the following:</p>
<ol type="1">
<li>Write your ucode in a file with extension <code>.S</code> and whose name starts with <code>rsp</code>. For instance <code>rsp_math.S</code>.</li>
<li>Add the corresponding object file (<code>rsp_math.o</code>) in your Makefile in the list of dependencies for building your ROM, like all the other object files that come from C files.</li>
<li>Declare the existence of the ucode in the source using <a class="el" href="rsp_8h.html#a1c69c50ce3eccc8d661dce878129b0b0" title="Define one RSP ucode compiled via libdragon&#39;s build system (n64.mk).">DEFINE_RSP_UCODE</a>, for instance <code><a class="el" href="rsp_8h.html#a1c69c50ce3eccc8d661dce878129b0b0" title="Define one RSP ucode compiled via libdragon&#39;s build system (n64.mk).">DEFINE_RSP_UCODE(rsp_math)</a></code>.</li>
</ol>
<p >At this point, you can load the ucode using <a class="el" href="rsp_8h.html#abaaa649a5d63d3a901aa029f18743852" title="Load a RSP ucode.">rsp_load</a> and run it using either <a class="el" href="rsp_8h.html#a9b06ba89506266ccb7c962872f0c783b" title="Run RSP ucode.">rsp_run</a>, or <a class="el" href="rsp_8h.html#a896f4959706e9ecb62ecf2de43bcb276" title="Run RSP async.">rsp_run_async</a> (and later synchronize with <a class="el" href="rsp_8h.html#a5d8697b67857ad9bd55885c0eb79c984" title="Wait until RSP has finished processing.">rsp_wait</a>). You can look at the <code>ucodetest</code> example which is a very minimal program that does some RSP programming.</p>
<p >If you don't use n64.mk, you will have to come up with your own way to load the ucode text and data segment into the ROM, and then either define your own <a class="el" href="structrsp__ucode__t.html" title="RSP ucode definition.">rsp_ucode_t</a> structure, or manually call the lower level functions <a class="el" href="rsp_8h.html#a0508fe05f465102e111d6f6ae0598058" title="Do a DMA transfer to load a piece of code into RSP IMEM.">rsp_load_code</a> and <a class="el" href="rsp_8h.html#ac3b056a6e41df010803e842867700089" title="Do a DMA transfer to load a piece of data into RSP DMEM.">rsp_load_data</a>.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Reading and writing data to RSP</h2>
<p >To provide input and read output from the RSP, there are a few possible ways:</p>
<ol type="1">
<li>Directly access RSP DMEM using the <a class="el" href="rsp_8h.html#af2eae5f6aa7c8ebae3255e00fa7fb23d" title="RSP DMEM: 4K of data memory.">SP_DMEM</a> macro. The DMEM is memory mapped into the CPU address space, so it can be accessed directly. Only 32-bit reads and writes are supported. Note that you can only access DMEM while the RSP is not running.</li>
<li>Run a DMA transfer using <a class="el" href="rsp_8h.html#ac3b056a6e41df010803e842867700089" title="Do a DMA transfer to load a piece of data into RSP DMEM.">rsp_load_data</a> or <a class="el" href="rsp_8h.html#adf9587d4d7fcafe85c672163c24972c0" title="Do a DMA transfer to load a piece of data from RSP DMEM to RDRAM.">rsp_read_data</a>. This is generally faster then accessing DMEM especially for larger transfers, but like all DMA transfers it requires the RDRAM buffer to be 8-byte aligned.</li>
<li>Have the RSP do DMA transfers to and from RDRAM. This needs to be part of the ucode program.</li>
</ol>
<h2><a class="anchor" id="autotoc_md11"></a>
RSP crashes</h2>
<p >RSP does not have any concept of exception. So in general it is not possible to tell whether something went wrong while running the ucode.</p>
<p >We define "RSP crash" any situation in which the RSP is behaving in an unexpected way. For instance, it may have returned corrupted data, or have stopped responding (eg: it is in an infinite loop), or has interrupted its execution before providing a result (eg: a signal has not been set in the status register).</p>
<p >When the CPU notices that the RSP may have crashed, it can invoke the <a class="el" href="rsp_8h.html#ae79047e3c1b28e7ed6b5e71025bcd1bb" title="Abort the program showing a RSP crash screen.">rsp_crash</a> function. This function interrupts the program showing a crash screen that contains a full register dump, and then aborts execution, so it must be used in non-recoverable situations. A even more complete dump that includes also a full DMEM dump is sent via <a class="el" href="debug_8h.html#aa3e8be416ef1525cfd3230204b56d184" title="Write a message to the debugging channel.">debugf</a> on the debugging spew (see the debugging library to check how to hook up to it). A function <a class="el" href="rsp_8h.html#a67ef683f18a90998c1711cd03a220ca9" title="Abort the program showing a RSP crash screen with a symptom message.">rsp_crashf</a> is also available in case the CPU wants to provide a message on the symptom that was used to detect the RSP crash (eg: <code>rsp_crashf("computed data is corrupted")</code>).</p>
<p >To help detect RSP crashes that involve timeouts, a macro <a class="el" href="rsp_8h.html#aef223885601547c7ff27b55520714076" title="Create a loop that waits for some condition that is related to RSP, aborting with a RSP crash after a...">RSP_WAIT_LOOP</a> is available that can be used to implement CPU busy loops where the CPU waits for the RSP to do something. The macro just simplifies the creation of a loop with a timeout that calls <a class="el" href="rsp_8h.html#ae79047e3c1b28e7ed6b5e71025bcd1bb" title="Abort the program showing a RSP crash screen.">rsp_crash</a>, the actual condition to wait for is left to the caller for the maximum programming flexibility. Notice that <a class="el" href="rsp_8h.html#a5d8697b67857ad9bd55885c0eb79c984" title="Wait until RSP has finished processing.">rsp_wait</a> and <a class="el" href="rsp_8h.html#a9b06ba89506266ccb7c962872f0c783b" title="Run RSP ucode.">rsp_run</a> use <a class="el" href="rsp_8h.html#aef223885601547c7ff27b55520714076" title="Create a loop that waits for some condition that is related to RSP, aborting with a RSP crash after a...">RSP_WAIT_LOOP</a> internally with a timeout of 500ms to wait for the RSP to finish execution of the ucode, so using those APIs is enough to detect infinite loops in ucode execution and trigger a RSP crash screen.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Custom ucode crash handlers</h2>
<p >It may be useful to also dump ucode-specific information when the crash screen is triggered. For instance, a ucode might want to dump on the screen some important variable or buffers taken from DMEM, or even reconstruct some state by looking at the registers. To do so, it is possible to register a ucode-specific crash handler by filling the <code>crash_handler</code> field in the <a class="el" href="structrsp__ucode__t.html" title="RSP ucode definition.">rsp_ucode_t</a> structure (it can be done either at runtime, or at compile-time when using the <a class="el" href="rsp_8h.html#a1c69c50ce3eccc8d661dce878129b0b0" title="Define one RSP ucode compiled via libdragon&#39;s build system (n64.mk).">DEFINE_RSP_UCODE</a> macro).</p>
<p >The crash handler will be called by the RSP crash screen and can either add information on the screen (via printf) or dump them to the debugging log (via debugf). It receives a <a class="el" href="rsp_8h.html#structrsp__snapshot__t" title="Snapshot of the register status of the RSP.">rsp_snapshot_t</a>, which is a full snapshot of the whole RSP state at the moment of crash, including all registers (scalars and vectors), all COP0/COP2 registers, and the full IMEM and DMEM contents.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
RSP asserts</h2>
<p >Since RSP debugging is quite complex due to the limited available communication channels, it is advised to adopt defensive programming while writing RSP ucode. The header file rsp.inc provides a set of assert macros that can be used in the RSP ucode to check for assumptions and invariants, similar to the C assert. To use them, also include the file rsp_assert.inc in your text segment.</p>
<p >When the RSP hits an assert, it enters an infinite loop, that will be eventually detected by the CPU, triggering the RSP crash screen. Each assertion can define a numeric assert code that will be shown in the crash screen.</p>
<p >To further help with debugging, it is possible to register a custom assert manager in the ucode. Similar to the crash handler, the assert handler will be called when an assert is triggered and will be provided with a <a class="el" href="rsp_8h.html#structrsp__snapshot__t" title="Snapshot of the register status of the RSP.">rsp_snapshot_t</a>, and the assert code. The assert handler can be used to parse the assert code and display a proper assert message (about two lines of text). Since each assert is placed in a specific point in the code, the assert handler can inspect the register contents at the point of assertion to provide further information on the crash. Notice that the crash handler will still be called also for asserts and remains the best place where display a dump of the main internal data structures of the overlay.</p>
<p >The RSP assert macros are compiled away when NDEBUG is defined (just like the C assert), so that it is possible to remove them from the final build in case of memory constraints. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Mar 19 2022 20:30:23 for libdragon by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
